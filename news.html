<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>NEWS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            padding-bottom: 120px;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .source-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .source-btn {
            padding: 6px 12px;
            font-size: 9px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
            white-space: nowrap;
            font-family: var(--font-stack);
        }

        .source-btn.active {
            background: var(--text-color);
            color: var(--bg-color);
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .news-item {
            border: 1px solid var(--border-color);
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .news-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .news-source {
            font-size: 9px;
            opacity: 0.4;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .news-title {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .news-excerpt {
            font-size: 11px;
            opacity: 0.6;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-date {
            font-size: 9px;
            opacity: 0.4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.5;
        }

        .error {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            border: 1px dashed var(--border-color);
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 15px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 10px;
        }

        .refresh-btn:hover {
            background: var(--text-color);
            color: var(--bg-color);
        }

        /* Categories */
        .category-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .cat-tech {
            background: #3b82f6;
        }

        .cat-politics {
            background: #ef4444;
        }

        .cat-economy {
            background: #10b981;
        }

        .cat-sport {
            background: #f59e0b;
        }

        .cat-general {
            background: #8b5cf6;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-bar">
            <h1>NEWS</h1>
            <button class="refresh-btn" onclick="loadNews()">↻ REFRESH</button>
        </div>

        <div class="source-bar" id="sourceBar">
            <button class="source-btn active" data-source="all">TUTTI</button>
            <button class="source-btn" data-source="ansa">ANSA</button>
            <button class="source-btn" data-source="repubblica">REPUBBLICA</button>
            <button class="source-btn" data-source="corriere">CORRIERE</button>
            <button class="source-btn" data-source="sole24ore">SOLE 24 ORE</button>
            <button class="source-btn" data-source="ilpost">IL POST</button>
        </div>

        <div class="news-list" id="newsList">
            <div class="loading">LOADING NEWS...</div>
        </div>
    </div>

    <div class="toolbar">
        <a href="index.html">[HOME]</a>
    </div>

    <script>
        // Italian news RSS feeds
        const RSS_FEEDS = {
            ansa: 'https://www.ansa.it/sito/ansait_rss.xml',
            repubblica: 'https://www.repubblica.it/rss/homepage/rss2.0.xml',
            corriere: 'https://xml2.corriereobjects.it/rss/homepage.xml',
            sole24ore: 'https://www.ilsole24ore.com/rss/italia.xml',
            ilpost: 'https://www.ilpost.it/feed/'
        };

        // RSS to JSON proxy (free, no key needed)
        const PROXY_URL = 'https://api.rss2json.com/v1/api.json?rss_url=';

        let currentSource = 'all';
        let allNews = [];

        // Source switching
        document.querySelectorAll('.source-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.source-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSource = btn.dataset.source;
                renderNews();
            };
        });

        async function fetchFeed(source, url) {
            try {
                const res = await fetch(PROXY_URL + encodeURIComponent(url));
                if (!res.ok) return [];
                const data = await res.json();

                if (data.status !== 'ok') return [];

                return data.items.map(item => ({
                    source: source.toUpperCase(),
                    sourceKey: source,
                    title: item.title,
                    excerpt: stripHtml(item.description || item.content || ''),
                    link: item.link,
                    date: new Date(item.pubDate),
                    category: detectCategory(item.title + ' ' + (item.description || ''))
                }));
            } catch (e) {
                console.error(`Error fetching ${source}:`, e);
                return [];
            }
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function detectCategory(text) {
            const lower = text.toLowerCase();
            if (lower.includes('tecnolog') || lower.includes('tech') || lower.includes('digital') || lower.includes('intelligenza artificiale')) return 'tech';
            if (lower.includes('politic') || lower.includes('governo') || lower.includes('parlamento') || lower.includes('ministro')) return 'politics';
            if (lower.includes('econom') || lower.includes('borsa') || lower.includes('finanz') || lower.includes('mercati')) return 'economy';
            if (lower.includes('calcio') || lower.includes('sport') || lower.includes('serie a') || lower.includes('champions')) return 'sport';
            return 'general';
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));

            if (hours < 1) return 'Adesso';
            if (hours < 24) return `${hours}h fa`;

            const days = Math.floor(hours / 24);
            if (days === 1) return 'Ieri';
            return `${days}g fa`;
        }

        async function loadNews() {
            const list = document.getElementById('newsList');
            list.innerHTML = '<div class="loading">CARICAMENTO...</div>';

            const promises = Object.entries(RSS_FEEDS).map(([source, url]) =>
                fetchFeed(source, url)
            );

            const results = await Promise.all(promises);
            allNews = results.flat();

            // Sort by date (newest first)
            allNews.sort((a, b) => b.date - a.date);

            renderNews();
        }

        function renderNews() {
            const list = document.getElementById('newsList');

            let filtered = allNews;
            if (currentSource !== 'all') {
                filtered = allNews.filter(n => n.sourceKey === currentSource);
            }

            if (filtered.length === 0) {
                list.innerHTML = '<div class="error">Nessuna notizia trovata. Riprova più tardi.</div>';
                return;
            }

            // Show top 30 news
            list.innerHTML = filtered.slice(0, 30).map(news => `
                <article class="news-item" onclick="window.open('${news.link}', '_blank')">
                    <div class="news-source">
                        <span><span class="category-dot cat-${news.category}"></span>${news.source}</span>
                        <span class="news-date">${formatDate(news.date)}</span>
                    </div>
                    <div class="news-title">${news.title}</div>
                    <div class="news-excerpt">${news.excerpt.substring(0, 150)}${news.excerpt.length > 150 ? '...' : ''}</div>
                </article>
            `).join('');
        }

        // Initial load
        loadNews();

        // Auto-refresh every 5 minutes
        setInterval(loadNews, 5 * 60 * 1000);
    </script>

</body>

</html>