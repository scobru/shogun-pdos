<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>SMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .header-bar h1 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .my-number {
            font-size: 11px;
            opacity: 0.6;
            padding: 4px 10px;
            border: 1px dashed var(--border-color);
            cursor: pointer;
        }

        .my-number:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .new-msg-btn {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 8px 14px;
            font-family: var(--font-stack);
            font-size: 11px;
            cursor: pointer;
        }

        .new-msg-btn:hover {
            opacity: 0.8;
        }

        /* Layout */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - Conversations list */
        .sidebar {
            width: 280px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--bg-color);
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .chat-area {
                width: 100% !important;
            }
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }

        .sidebar-header input {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 12px;
            font-family: var(--font-stack);
            font-size: 11px;
        }

        .sidebar-header button {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 11px;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .conv-info {
            flex: 1;
            overflow: hidden;
        }

        .conv-number {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .conv-preview {
            font-size: 10px;
            opacity: 0.5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conv-time {
            font-size: 9px;
            opacity: 0.4;
        }

        .unread-badge {
            background: #3b82f6;
            color: #fff;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-btn {
            display: none;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: block;
            }
        }

        .chat-recipient {
            font-size: 13px;
        }

        .chat-recipient-pub {
            font-size: 9px;
            opacity: 0.4;
            margin-top: 2px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--text-color);
            color: var(--bg-color);
        }

        .message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 9px;
            opacity: 0.5;
            margin-top: 4px;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .no-messages {
            text-align: center;
            opacity: 0.4;
            font-size: 12px;
            margin-top: 40px;
        }

        /* Input area */
        .input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            background: var(--bg-color);
            margin-bottom: 50px;
            /* Space for toolbar */
        }

        .input-area input {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px;
            font-family: var(--font-stack);
            font-size: 12px;
        }

        .input-area button {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 11px;
        }

        .input-area button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Empty state */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            padding: 40px;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 12px;
            line-height: 1.6;
        }

        /* Login required */
        .login-required {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .login-required p {
            font-size: 12px;
            opacity: 0.6;
            margin-bottom: 20px;
        }

        .login-required button {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 11px;
        }

        /* Toolbar */
        .toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }

        /* Contact search modal - using ID for highest specificity */
        #newConvModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 99999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #newConvModal.active {
            display: flex !important;
        }

        .modal {
            background: #000;
            border: 1px solid #fff;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            color: #fff;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
        }

        .sms-modal-box h2 {
            margin-bottom: 20px;
            font-size: 14px;
        }

        .sms-modal-close {
            float: right;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .sms-modal-close:hover {
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 10px;
            opacity: 0.6;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            font-size: 12px;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 11px;
            margin-top: 10px;
        }

        .user-directory {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .directory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed var(--border-color);
            font-size: 11px;
            cursor: pointer;
        }

        .directory-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header-bar">
            <h1>üì± SMS</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="newMsgBtn" class="new-msg-btn">+ NEW</button>
                <div class="my-number" id="myNumber">
                    Loading...
                </div>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <!-- Will be populated based on login state -->
        </div>
    </div>

    <!-- New Conversation Modal -->
    <div id="newConvModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:999999; justify-content:center; align-items:center; padding:20px;">
        <div class="sms-modal-box">
            <button class="sms-modal-close" id="closeModalBtn">√ó</button>
            <h2>üìû NEW MESSAGE</h2>

            <div class="form-group">
                <label>Enter Phone Number</label>
                <input type="text" id="recipientNumber" placeholder="e.g. 1234567890">
            </div>

            <button class="submit-btn" id="startChatBtn">START CHAT</button>

            <div class="user-directory" id="userDirectory">
                <p style="font-size: 10px; opacity: 0.5;">Searching for users...</p>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <a href="index.html">[HOME]</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script>
        // Initialize Gun
        const gunUrl = localStorage.getItem('gun-relay-url') || 'https://shogun-relay.scobrudot.dev/gun';
        const gun = Gun({ localStorage: false, peers: [gunUrl] });
        const user = gun.user().recall({ sessionStorage: true });

        let myNumber = null;
        let myKeys = null;
        let conversations = {};
        let currentConversation = null;
        let messagesListener = null;

        // Generate a unique phone number from user's public key
        function generatePhoneNumber(pub) {
            // Create a numeric hash from the public key
            let hash = 0;
            for (let i = 0; i < pub.length; i++) {
                const char = pub.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            // Make it positive and format as phone number
            const num = Math.abs(hash) % 10000000000;
            return num.toString().padStart(10, '0');
        }

        // Copy number to clipboard
        async function copyMyNumber() {
            if (myNumber) {
                await navigator.clipboard.writeText(myNumber);
                const el = document.getElementById('myNumber');
                const original = el.textContent;
                el.textContent = 'COPIED!';
                setTimeout(() => el.textContent = original, 1500);
            }
        }

        // Register user's phone number and keys in public directory
        function registerInDirectory() {
            if (!user.is) return;

            const pub = user.is.pub;
            const epub = user.is.epub;
            myNumber = generatePhoneNumber(pub);

            // Store in global directory: shogun/sms/directory/[number]
            gun.get('shogun').get('sms').get('directory').get(myNumber).put({
                pub: pub,
                epub: epub,
                number: myNumber,
                updatedAt: Date.now()
            });

            // Also store reverse lookup: shogun/sms/pubToNumber/[pub]
            gun.get('shogun').get('sms').get('pubToNumber').get(pub).put({
                number: myNumber
            });

            document.getElementById('myNumber').textContent = `#${myNumber}`;
        }

        // Look up user by phone number
        async function lookupByNumber(number) {
            return new Promise((resolve) => {
                gun.get('shogun').get('sms').get('directory').get(number).once((data) => {
                    resolve(data || null);
                });
            });
        }

        // Get conversation ID (consistent regardless of who initiated)
        function getConversationId(number1, number2) {
            return [number1, number2].sort().join('_');
        }

        // Load conversations
        function loadConversations() {
            if (!myNumber) return;

            gun.get('shogun').get('sms').get('users').get(myNumber).get('conversations').map().on((data, convId) => {
                if (data && !data.deleted) {
                    conversations[convId] = {
                        id: convId,
                        recipientNumber: data.recipientNumber,
                        recipientPub: data.recipientPub,
                        recipientEpub: data.recipientEpub,
                        lastMessage: data.lastMessage || '',
                        lastTime: data.lastTime || 0,
                        unread: data.unread || 0
                    };
                    renderConversations();
                }
            });
        }

        // Start a new conversation
        async function startConversation() {
            const number = document.getElementById('recipientNumber').value.trim();
            if (!number) {
                alert('Please enter a phone number');
                return;
            }

            const recipient = await lookupByNumber(number);
            if (!recipient) {
                alert('User not found. They need to open SMS app first to register.');
                return;
            }

            if (number === myNumber) {
                alert('You cannot message yourself!');
                return;
            }

            const convId = getConversationId(myNumber, number);

            // Save conversation for current user
            gun.get('shogun').get('sms').get('users').get(myNumber).get('conversations').get(convId).put({
                recipientNumber: number,
                recipientPub: recipient.pub,
                recipientEpub: recipient.epub,
                lastMessage: '',
                lastTime: Date.now(),
                unread: 0
            });

            closeNewConvModal();
            selectConversation(convId, number, recipient.pub, recipient.epub);
        }

        // Select conversation to view
        function selectConversation(convId, recipientNumber, recipientPub, recipientEpub) {
            currentConversation = {
                id: convId,
                recipientNumber,
                recipientPub,
                recipientEpub
            };

            // Mark as read
            gun.get('shogun').get('sms').get('users').get(myNumber).get('conversations').get(convId).put({
                unread: 0
            });

            renderChatArea();
            loadMessages();

            // Close sidebar on mobile
            document.querySelector('.sidebar')?.classList.remove('open');
        }

        // Load messages for current conversation
        function loadMessages() {
            if (!currentConversation) return;

            // Clear previous listener
            if (messagesListener) {
                messagesListener.off();
            }

            const container = document.getElementById('messagesContainer');
            if (!container) return;

            container.innerHTML = '';
            const messages = [];

            messagesListener = gun.get('shogun').get('sms').get('messages').get(currentConversation.id).map().on(async (encData, msgId) => {
                if (!encData || messages.find(m => m.id === msgId)) return;

                try {
                    // Decrypt message
                    let decrypted;
                    if (encData.senderNumber === myNumber) {
                        // I sent this - decrypt with my key using contentSelf (encrypted for me)
                        // Fallback to content if contentSelf is missing (legacy) although it likely won't decrypt
                        decrypted = await SEA.decrypt(encData.contentSelf || encData.content, myKeys);
                    } else {
                        // I received this - derive shared secret
                        const secret = await SEA.secret(currentConversation.recipientEpub, myKeys);
                        decrypted = await SEA.decrypt(encData.content, secret);
                    }

                    if (decrypted) {
                        messages.push({
                            id: msgId,
                            text: decrypted,
                            senderNumber: encData.senderNumber,
                            timestamp: encData.timestamp,
                            sent: encData.senderNumber === myNumber
                        });

                        // Sort and render
                        messages.sort((a, b) => a.timestamp - b.timestamp);
                        renderMessages(messages);
                    }
                } catch (e) {
                    console.error('Decrypt error:', e);
                }
            });
        }

        // Render messages
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;

            if (messages.length === 0) {
                container.innerHTML = '<div class="no-messages">No messages yet. Say hello!</div>';
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.sent ? 'sent' : 'received'}">
                    <div class="message-text">${escapeHtml(msg.text)}</div>
                    <div class="message-time">${formatTime(msg.timestamp)}</div>
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            if (!currentConversation || !user.is) return;

            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'SENDING...';

            try {
                // Encrypt for recipient
                const secret = await SEA.secret(currentConversation.recipientEpub, myKeys);
                const encryptedForRecipient = await SEA.encrypt(text, secret);

                // Also encrypt for self (to be able to read later)
                const encryptedForSelf = await SEA.encrypt(text, myKeys);

                const msgId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const timestamp = Date.now();

                // Save message with both encryptions
                gun.get('shogun').get('sms').get('messages').get(currentConversation.id).get(msgId).put({
                    content: encryptedForRecipient,
                    contentSelf: encryptedForSelf,
                    senderNumber: myNumber,
                    timestamp: timestamp
                });

                // Update conversation for sender
                gun.get('shogun').get('sms').get('users').get(myNumber).get('conversations').get(currentConversation.id).put({
                    lastMessage: text.substring(0, 50),
                    lastTime: timestamp
                });

                // Update/create conversation for recipient
                gun.get('shogun').get('sms').get('users').get(currentConversation.recipientNumber).get('conversations').get(currentConversation.id).put({
                    recipientNumber: myNumber,
                    recipientPub: user.is.pub,
                    recipientEpub: user.is.epub,
                    lastMessage: text.substring(0, 50),
                    lastTime: timestamp,
                    unread: 1 // Notify recipient
                });

                input.value = '';
            } catch (e) {
                console.error('Send error:', e);
                alert('Failed to send message');
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'SEND';
        }

        // Render conversations list
        function renderConversations() {
            const list = document.getElementById('conversationList');
            if (!list) return;

            const sorted = Object.values(conversations).sort((a, b) => (b.lastTime || 0) - (a.lastTime || 0));

            if (sorted.length === 0) {
                list.innerHTML = `
                    <div style="padding: 20px; text-align: center; opacity: 0.5; font-size: 11px;">
                        No conversations yet.<br>Start one by clicking + NEW
                    </div>
                `;
                return;
            }

            list.innerHTML = sorted.map(conv => `
                <div class="conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}" 
                     data-convid="${conv.id}" data-number="${conv.recipientNumber}" data-pub="${conv.recipientPub}" data-epub="${conv.recipientEpub}">
                    <div class="conv-info">
                        <div class="conv-number">#${conv.recipientNumber}</div>
                        <div class="conv-preview">${escapeHtml(conv.lastMessage || 'No messages')}</div>
                    </div>
                    <div>
                        ${conv.unread > 0 ? `<span class="unread-badge">${conv.unread}</span>` : ''}
                        <div class="conv-time">${formatTime(conv.lastTime)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Render full chat area
        function renderChatArea() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            if (!currentConversation) {
                chatContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div class="empty-state-text">
                            Select a conversation or start a new one<br>
                            to begin messaging.
                        </div>
                    </div>
                `;
                return;
            }

            chatContainer.innerHTML = `
                <div class="chat-header">
                    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <div>
                        <div class="chat-recipient">#${currentConversation.recipientNumber}</div>
                        <div class="chat-recipient-pub">${currentConversation.recipientPub.substring(0, 20)}...</div>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer">
                    <div class="no-messages">Loading messages...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button id="sendBtn" onclick="sendMessage()">SEND</button>
                </div>
            `;
        }

        // Initialize app UI based on auth state
        function initializeUI() {
            const mainContent = document.getElementById('mainContent');

            if (!user.is) {
                // Not logged in
                mainContent.innerHTML = `
                    <div class="login-required">
                        <p>üîê You need to be logged in to use SMS.<br>
                        Your phone number is generated from your account.</p>
                        <button onclick="window.location.href='index.html'">GO TO LOGIN</button>
                    </div>
                `;
                document.getElementById('myNumber').textContent = 'Not logged in';
                return;
            }

            // Store keys reference
            myKeys = user._.sea;

            // Register in directory
            registerInDirectory();

            // Render full UI
            mainContent.innerHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <input type="text" id="searchConv" placeholder="Search conversations...">
                    </div>
                    <div class="conversation-list" id="conversationList"></div>
                </div>
                <div class="chat-area" id="chatContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div class="empty-state-text">
                            Select a conversation or start a new one<br>
                            to begin messaging.
                        </div>
                    </div>
                </div>
            `;

            loadConversations();
            loadUserDirectory();
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            document.getElementById('sidebar')?.classList.toggle('open');
        }

        // Modal functions
        function openNewConvModal() {
            const modal = document.getElementById('newConvModal');
            modal.style.display = 'flex';
            console.log('Modal opened, display:', modal.style.display);
            document.getElementById('recipientNumber').focus();
        }

        function closeNewConvModal() {
            document.getElementById('newConvModal').style.display = 'none';
            document.getElementById('recipientNumber').value = '';
        }

        // Load user directory for easy selection
        function loadUserDirectory() {
            const dir = document.getElementById('userDirectory');
            if (!dir) return;

            const users = [];
            gun.get('shogun').get('sms').get('directory').map().once((data, number) => {
                if (data && data.pub && number !== myNumber) {
                    users.push({ number, pub: data.pub, epub: data.epub });

                    // Render directory
                    dir.innerHTML = users.length > 0
                        ? `<p style="font-size: 10px; opacity: 0.5; margin-bottom: 10px;">AVAILABLE USERS:</p>` +
                        users.map(u => `
                              <div class="directory-item" data-number="${u.number}">
                                  <span>#${u.number}</span>
                                  <span style="opacity: 0.4; font-size: 9px;">${u.pub.substring(0, 12)}...</span>
                              </div>
                          `).join('')
                        : '<p style="font-size: 10px; opacity: 0.5;">No other users found yet.</p>';
                }
            });
        }

        // Select user from directory
        function selectFromDirectory(number, pub, epub) {
            document.getElementById('recipientNumber').value = number;
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            return date.toLocaleDateString();
        }

        // ==================== EVENT LISTENERS ====================
        // These use getElementById which is more reliable than inline onclick

        // New message button (in header - always visible)
        document.getElementById('newMsgBtn').addEventListener('click', function () {
            console.log('New MSG button clicked');
            openNewConvModal();
        });

        // Close modal button
        document.getElementById('closeModalBtn').addEventListener('click', function () {
            closeNewConvModal();
        });

        // Start chat button
        document.getElementById('startChatBtn').addEventListener('click', function () {
            startConversation();
        });

        // Copy number on click
        document.getElementById('myNumber').addEventListener('click', function () {
            copyMyNumber();
        });

        // Close modal on overlay click
        document.getElementById('newConvModal').addEventListener('click', function (e) {
            if (e.target.id === 'newConvModal') closeNewConvModal();
        });

        // ==================== EVENT DELEGATION FOR DYNAMIC CONTENT ====================
        document.addEventListener('click', function (e) {
            // Handle directory item clicks
            if (e.target.closest('.directory-item')) {
                const item = e.target.closest('.directory-item');
                const number = item.dataset.number;
                if (number) {
                    document.getElementById('recipientNumber').value = number;
                }
            }

            // Handle conversation item clicks
            if (e.target.closest('.conversation-item')) {
                const item = e.target.closest('.conversation-item');
                const convId = item.dataset.convid;
                const recipientNumber = item.dataset.number;
                const recipientPub = item.dataset.pub;
                const recipientEpub = item.dataset.epub;
                if (convId) {
                    selectConversation(convId, recipientNumber, recipientPub, recipientEpub);
                }
            }
        });

        // Initialize on auth
        gun.on('auth', () => {
            setTimeout(initializeUI, 100);
        });

        // Check if already logged in
        if (user.is) {
            initializeUI();
        } else {
            // Wait a bit for session recall
            setTimeout(() => {
                if (user.is) {
                    initializeUI();
                } else {
                    initializeUI(); // Will show login required
                }
            }, 500);
        }
    </script>
</body>

</html>