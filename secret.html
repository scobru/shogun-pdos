<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Secret</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html {
        color-scheme: light dark;
        background: #0a0a0a;
        color: #e0e0e0;

        @media (prefers-color-scheme: light) {
            background: #fafafa;
            color: #161616;
        }
    }

    body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        font: 16px/1.5 system-ui;
    }

    .container {
        width: 100%;
        max-width: 600px;
    }

    h1 {
        font-size: 24px;
        margin-bottom: 8px;
        text-align: center;
    }

    .subtitle {
        text-align: center;
        opacity: 0.6;
        margin-bottom: 24px;
        font-size: 14px;
    }

    textarea {
        width: 100%;
        height: 200px;
        padding: 16px;
        border: 2px solid #333;
        border-radius: 12px;
        font: inherit;
        resize: vertical;
        background: #111;
        color: #e0e0e0;
        margin-bottom: 16px;

        @media (prefers-color-scheme: light) {
            background: #fff;
            color: #161616;
            border-color: #ddd;
        }
    }

    textarea:focus {
        outline: none;
        border-color: #8b5cf6;
    }

    .row {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #333;
        border-radius: 8px;
        font: inherit;
        background: #111;
        color: #e0e0e0;

        @media (prefers-color-scheme: light) {
            background: #fff;
            color: #161616;
            border-color: #ddd;
        }
    }

    input:focus {
        outline: none;
        border-color: #8b5cf6;
    }

    button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font: inherit;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
    }

    .primary {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    .secondary {
        background: #333;
        color: #e0e0e0;

        @media (prefers-color-scheme: light) {
            background: #e5e5e5;
            color: #333;
        }
    }

    .actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .status {
        text-align: center;
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
    }

    .status.success {
        display: block;
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .status.error {
        display: block;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .locked {
        text-align: center;
        padding: 40px;
    }

    .lock-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .info {
        margin-top: 24px;
        padding: 16px;
        background: #1a1a1a;
        border-radius: 8px;
        font-size: 13px;
        opacity: 0.7;

        @media (prefers-color-scheme: light) {
            background: #f0f0f0;
        }
    }

    .info code {
        background: #333;
        padding: 2px 6px;
        border-radius: 4px;

        @media (prefers-color-scheme: light) {
            background: #ddd;
        }
    }
</style>

<div class="container">
    <h1>üîê Secret</h1>
    <p class="subtitle">Encrypted notes in your URL. Zero servers.</p>

    <div id="editor-view">
        <textarea id="message" placeholder="Write your secret message..."></textarea>
        <div class="row">
            <input type="password" id="password" placeholder="Password (remember it!)">
        </div>
        <div class="actions">
            <button class="primary" id="encrypt">üîí Encrypt & Share</button>
        </div>
        <div class="info">
            <strong>How it works:</strong><br>
            Your message is encrypted with <code>AES-GCM</code> in your browser.<br>
            The encrypted data goes in the URL. Share the link + password separately.
        </div>
    </div>

    <div id="decrypt-view" style="display:none">
        <div class="locked">
            <div class="lock-icon">üîí</div>
            <p>This message is encrypted</p>
        </div>
        <div class="row">
            <input type="password" id="decrypt-password" placeholder="Enter password to decrypt">
            <button class="primary" id="decrypt">üîì Decrypt</button>
        </div>
        <textarea id="decrypted" readonly style="display:none"></textarea>
        <div class="actions" style="margin-top:16px">
            <button class="secondary" id="new-secret">‚ú® Create New Secret</button>
        </div>
    </div>

    <div id="status" class="status"></div>
</div>

<script>
    const editorView = document.getElementById('editor-view')
    const decryptView = document.getElementById('decrypt-view')
    const message = document.getElementById('message')
    const password = document.getElementById('password')
    const decryptPassword = document.getElementById('decrypt-password')
    const decrypted = document.getElementById('decrypted')
    const status = document.getElementById('status')

    // Check if we have encrypted data in URL
    if (location.hash.length > 1) {
        editorView.style.display = 'none'
        decryptView.style.display = 'block'
    }

    document.getElementById('encrypt').addEventListener('click', async () => {
        const msg = message.value
        const pwd = password.value

        if (!msg || !pwd) {
            showStatus('Please enter a message and password', 'error')
            return
        }

        try {
            const encrypted = await encrypt(msg, pwd)
            location.hash = encrypted
            await navigator.clipboard.writeText(location.href)
            showStatus('‚úì Encrypted! Link copied to clipboard. Share it securely!', 'success')
        } catch (e) {
            showStatus('Encryption failed: ' + e.message, 'error')
        }
    })

    document.getElementById('decrypt').addEventListener('click', async () => {
        const pwd = decryptPassword.value
        const data = location.hash.slice(1)

        if (!pwd) {
            showStatus('Please enter the password', 'error')
            return
        }

        try {
            const msg = await decrypt(data, pwd)
            decrypted.value = msg
            decrypted.style.display = 'block'
            document.querySelector('.locked').style.display = 'none'
            showStatus('‚úì Decrypted successfully!', 'success')
        } catch (e) {
            showStatus('Wrong password or corrupted data', 'error')
        }
    })

    document.getElementById('new-secret').addEventListener('click', () => {
        location.hash = ''
        location.reload()
    })

    async function encrypt(text, password) {
        const enc = new TextEncoder()
        const keyMaterial = await crypto.subtle.importKey(
            'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
        )
        const salt = crypto.getRandomValues(new Uint8Array(16))
        const key = await crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
            keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt']
        )
        const iv = crypto.getRandomValues(new Uint8Array(12))
        const encrypted = await crypto.subtle.encrypt(
            { name: 'AES-GCM', iv }, key, enc.encode(text)
        )
        const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength)
        combined.set(salt, 0)
        combined.set(iv, salt.length)
        combined.set(new Uint8Array(encrypted), salt.length + iv.length)
        return btoa(String.fromCharCode(...combined))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '')
    }

    async function decrypt(data, password) {
        const binary = atob(data.replace(/-/g, '+').replace(/_/g, '/'))
        const combined = Uint8Array.from(binary, c => c.charCodeAt(0))
        const salt = combined.slice(0, 16)
        const iv = combined.slice(16, 28)
        const encrypted = combined.slice(28)

        const enc = new TextEncoder()
        const keyMaterial = await crypto.subtle.importKey(
            'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
        )
        const key = await crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
            keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
        )
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv }, key, encrypted
        )
        return new TextDecoder().decode(decrypted)
    }

    function showStatus(msg, type) {
        status.textContent = msg
        status.className = 'status ' + type
        setTimeout(() => status.className = 'status', 4000)
    }
</script>
