<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LIST</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            padding-bottom: 100px;

            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        input {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            padding: 12px;
            font-size: 16px;
            outline: none;
        }

        input:focus {
            border-color: var(--accent-color);
        }

        .add-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            font-size: 24px;
            width: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn:hover {
            background: var(--text-color);
            color: var(--bg-color);
        }

        .list {
            list-style: none;
            border: 1px solid var(--border-color);
        }

        .item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item:hover {
            background: #111;
        }

        .item.done span {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .check {
            width: 20px;
            height: 20px;
            border: 1px solid var(--border-color);
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .item.done .check::after {
            content: 'X';
        }

        span {
            flex: 1;
            word-break: break-word;
            font-size: 14px;
            text-transform: uppercase;
        }

        .del-btn {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-family: var(--font-stack);
            padding: 8px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.5;
        }

        .del-btn:hover {
            color: var(--accent-color);
            opacity: 1;
        }

        .empty {
            padding: 40px;
            text-align: center;
            opacity: 0.5;
            text-transform: uppercase;
            font-size: 12px;
        }

        .actions {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            justify-content: center;
        }

        .actions button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            padding: 12px;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 12px;
        }

        .actions button:hover {
            background: var(--text-color);
            color: var(--bg-color);
        }

        /* Toolbar */
        .toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 16px;
        }

        .toolbar a {
            color: var(--text-color);
            text-decoration: none;
            font-family: var(--font-stack);
            font-size: 14px;
            text-transform: uppercase;
        }
    </style>

    <div class="container">
        <header>
            <h1>LIST</h1>
        </header>

        <div class="input-row">
            <input type="text" id="input" placeholder="ADD ITEM..." aria-label="New item content" autofocus>
            <button class="add-btn" id="add" aria-label="Add item">+</button>
        </div>

        <div class="list" id="list"></div>

        <div class="actions">
            <button id="share">SHARE LIST</button>
            <button id="clear">CLEAR DONE</button>
        </div>
    </div>

    <div class="toolbar">
        <a href="index.html">[HOME]</a>
    </div>

    <div class="toast" id="toast">LINK COPIED</div>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script>
        let items = [];
        const input = document.getElementById('input');
        const listEl = document.getElementById('list');
        const toast = document.getElementById('toast');
        let gun, gunNode, user;

        // Initialize Gun
        const relayUrl = localStorage.getItem('gun-relay-url');
        if (relayUrl) {
            gun = Gun({ localStorage: false, peers: [relayUrl] });
            user = gun.user().recall({ sessionStorage: true });

            // Determine node based on user auth
            if (user.is) {
                gunNode = user.get('shogun-list');
            } else {
                gunNode = gun.get('shogun-list');
            }

            // Update from Gun
            gunNode.on(async (data) => {
                if (data && data.items) {
                    try {
                        let itemsData = data.items;
                        // Try to decrypt if user is logged in
                        if (user.is && user._.sea) {
                            try {
                                const decrypted = await SEA.decrypt(itemsData, user._.sea);
                                if (decrypted) itemsData = decrypted;
                            } catch (e) { /* Not encrypted or wrong key */ }
                        }
                        const remoteItems = JSON.parse(itemsData);
                        if (JSON.stringify(remoteItems) !== JSON.stringify(items)) {
                            items = remoteItems;
                            render();
                            updateHash();
                        }
                    } catch (e) { }
                }
            });
        }

        input.addEventListener('keypress', e => {
            if (e.key === 'Enter' && input.value.trim()) addItem();
        });

        document.getElementById('add').addEventListener('click', addItem);

        document.getElementById('share').addEventListener('click', async () => {
            await save();
            try {
                await navigator.clipboard.writeText(location.href);
                showToast('LINK COPIED');
            } catch {
                showToast('COPY FAILED');
            }
        });

        document.getElementById('clear').addEventListener('click', () => {
            items = items.filter(i => !i.done);
            render();
            save();
        });

        function addItem() {
            if (input.value.trim()) {
                items.push({ text: input.value.trim(), done: false, id: Date.now() });
                input.value = '';
                render();
                save();
            }
        }

        window.handleKey = (id, e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggle(id);
            }
        };

        window.toggle = id => {
            const i = items.find(x => x.id === id);
            if (i) {
                i.done = !i.done;
                render();
                // Restore focus to the toggled item
                const el = document.querySelector(`.item[data-id="${id}"]`);
                if (el) el.focus();
                save();
            }
        };

        window.del = (id, e) => {
            e.stopPropagation();
            items = items.filter(i => i.id !== id);
            render();
            save();
        };

        function render() {
            if (!items.length) {
                listEl.innerHTML = '<div class="empty">NO ITEMS</div>';
                return;
            }
            listEl.innerHTML = items.map(i => `
      <div class="item ${i.done ? 'done' : ''}"
           onclick="toggle(${i.id})"
           data-id="${i.id}"
           tabindex="0"
           role="checkbox"
           aria-checked="${i.done}"
           onkeydown="if(event.target === this) handleKey(${i.id}, event)">
        <div class="check" aria-hidden="true"></div>
        <span>${i.text.replace(/</g, '&lt;')}</span>
        <button class="del-btn"
                onclick="del(${i.id}, event)"
                aria-label="Delete ${i.text.replace(/"/g, '&quot;')}">
            [X]
        </button>
      </div>
    `).join('');
        }

        async function save() {
            // Sync to Gun with encryption
            if (gunNode) {
                let dataToSave = JSON.stringify(items);
                // Encrypt if user is logged in
                if (user.is && user._.sea) {
                    dataToSave = await SEA.encrypt(dataToSave, user._.sea);
                }
                gunNode.put({ items: dataToSave });
            }
            updateHash();
        }

        async function updateHash() {
            const h = await compress(JSON.stringify(items));
            history.replaceState({}, '', '#' + h);
            try { localStorage.setItem('list-hash', h); } catch { }
        }

        async function load() {
            try {
                // Load from Hash or LocalStorage as baseline
                let h = location.hash.slice(1);
                if (!h) h = localStorage.getItem('list-hash');
                if (h) items = JSON.parse(await decompress(h));
            } catch { }
            render();
        }

        async function compress(s) {
            const b = new TextEncoder().encode(s);
            const st = new CompressionStream('deflate-raw');
            const w = st.writable.getWriter();
            w.write(b); w.close();
            const buf = await new Response(st.readable).arrayBuffer();
            return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function decompress(b) {
            const bin = atob(b.replace(/-/g, '+').replace(/_/g, '/'));
            const arr = Uint8Array.from(bin, c => c.charCodeAt(0));
            const st = new DecompressionStream('deflate-raw');
            const w = st.writable.getWriter();
            w.write(arr); w.close();
            return new TextDecoder().decode(await new Response(st.readable).arrayBuffer());
        }

        function showToast(m) {
            toast.textContent = m;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        addEventListener('DOMContentLoaded', load);
        addEventListener('hashchange', load);
    </script>
