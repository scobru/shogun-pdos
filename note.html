<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Shogun NoBackend</title>
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    --text-color: #e0e0e0;
    --toolbar-bg: rgba(255, 255, 255, 0.1);
    --toolbar-border: rgba(255, 255, 255, 0.1);
    --btn-hover-bg: rgba(255, 255, 255, 0.1);
    --btn-hover-color: #fff;
  }

  [data-theme="light"] {
    --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
    --text-color: #102a43;
    --toolbar-bg: rgba(255, 255, 255, 0.9);
    --toolbar-border: rgba(0, 0, 0, 0.1);
    --btn-hover-bg: rgba(0, 0, 0, 0.05);
    --btn-hover-color: #102a43;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    background: var(--bg-gradient);
    color: var(--text-color);
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
  }

  body {
    font: 18px / 1.5 system-ui;
  }

  article {
    outline: none;
    padding: 20px max(20px, calc(50vw - 400px));
    padding-bottom: 80px;
    /* Space for toolbar */
    width: 100%;
    min-height: 100vh;
    tab-size: 4;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    white-space: pre-wrap;
    text-wrap-style: pretty;
    overflow-wrap: break-word;
  }

  .toolbar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--toolbar-bg);
    backdrop-filter: blur(10px);
    padding: 8px 16px;
    border-radius: 50px;
    display: flex;
    gap: 12px;
    align-items: center;
    border: 1px solid var(--toolbar-border);
    z-index: 100;
    transition: opacity 0.3s, background 0.3s, border-color 0.3s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .toolbar:hover {
    opacity: 1;
  }

  .btn {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
    text-decoration: none;
    font-size: 20px;
    width: 40px;
    height: 40px;
  }

  .btn:hover {
    background: var(--btn-hover-bg);
    color: var(--btn-hover-color);
  }

  .btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #22c55e);
    color: white !important;
  }

  .status {
    font-size: 12px;
    opacity: 0.5;
    margin: 0 8px;
    min-width: 60px;
    text-align: center;
  }

  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    padding: 8px 16px;
    background: #22c55e;
    color: white;
    border-radius: 20px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
</style>

<article contenteditable="plaintext-only" spellcheck></article>

<div class="toolbar">
  <a href="index.html" class="btn" title="Home">üè†</a>
  <button class="btn" id="theme-toggle" title="Toggle Theme">üåì</button>
  <div class="status" id="status">Saved</div>
  <button class="btn btn-primary" id="share" title="Share URL">üîó</button>
</div>

<div class="toast" id="toast">Link copied!</div>

<script>
  const article = document.querySelector('article')
  const statusEl = document.getElementById('status')
  const toastEl = document.getElementById('toast')

  // Theme logic
  const toggle = document.getElementById('theme-toggle');
  const storedTheme = localStorage.getItem('theme');
  if (storedTheme) {
    document.documentElement.setAttribute('data-theme', storedTheme);
  } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.setAttribute('data-theme', 'light');
  }
  toggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  });

  article.addEventListener('input', () => {
    statusEl.textContent = 'Typing...'
    debounce(500, save)()
  })

  addEventListener('DOMContentLoaded', load)
  addEventListener('hashchange', load)

  document.getElementById('share').addEventListener('click', async () => {
    await save()
    try {
      await navigator.clipboard.writeText(location.href)
      showToast()
    } catch (e) {
      statusEl.textContent = 'Copy failed'
    }
  })

  function showToast() {
    toastEl.classList.add('show')
    setTimeout(() => toastEl.classList.remove('show'), 2000)
  }

  async function load() {
    try {
      if (location.hash !== '') await set(location.hash)
      else {
        await set(localStorage.getItem('hash') ?? '')
        if (article.textContent) history.replaceState({}, '', await get())
        article.focus()
      }
    } catch (e) {
      article.textContent = ''
      article.removeAttribute('style')
      article.focus()
    }
    updateTitle()
  }

  async function save() {
    const hash = await get()
    if (location.hash !== hash) history.replaceState({}, '', hash)
    try { localStorage.setItem('hash', hash) } catch (e) { }
    statusEl.textContent = 'Saved'
    updateTitle()
  }

  async function set(hash) {
    if (!hash || hash === '#') return
    try {
      const [content, style] = (await decompress(hash.slice(1))).split('\x00')
      article.textContent = content
      if (style) article.setAttribute('style', style)
    } catch (e) {
      console.error('Decompress failed', e)
    }
  }

  async function get() {
    const style = article.getAttribute('style')
    const content = article.textContent + (style !== null ? '\x00' + style : '')
    return '#' + await compress(content)
  }

  function updateTitle() {
    const match = article.textContent.match(/^\n*#(.+)\n/)
    document.title = match?.[1] ?? 'Shogun Note'
  }

  async function compress(string) {
    try {
      const byteArray = new TextEncoder().encode(string)
      const stream = new CompressionStream('deflate-raw')
      const writer = stream.writable.getWriter()
      writer.write(byteArray)
      writer.close()
      const buffer = await new Response(stream.readable).arrayBuffer()
      // Base64Url encode manually for compatibility if needed, but using standard methods
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '')
    } catch (e) {
      console.error('Compress error', e);
      return '';
    }
  }

  async function decompress(b64) {
    try {
      const binStr = atob(b64.replace(/-/g, '+').replace(/_/g, '/'))
      const byteArray = new Uint8Array(binStr.length)
      for (let i = 0; i < binStr.length; i++) byteArray[i] = binStr.charCodeAt(i)
      const stream = new DecompressionStream('deflate-raw')
      const writer = stream.writable.getWriter()
      writer.write(byteArray)
      writer.close()
      const buffer = await new Response(stream.readable).arrayBuffer()
      return new TextDecoder().decode(buffer)
    } catch (e) {
      console.error('Decompress error', e);
      return '';
    }
  }

  function debounce(ms, fn) {
    let timer
    return (...args) => {
      clearTimeout(timer)
      timer = setTimeout(() => fn(...args), ms)
    }
  }
</script>