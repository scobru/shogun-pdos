<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>POLL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<style>
    body {
        padding: 20px;
        padding-bottom: 100px;
        
        align-items: center;
    }

    .container {
        width: 100%;
        max-width: 500px;
    }

    header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 20px;
    }.card {
        border: 1px solid var(--border-color);
        padding: 20px;
        margin-bottom: 20px;
    }

    h2 {
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 16px;
        border-bottom: 1px dashed var(--border-color);
        padding-bottom: 8px;
    }

    input {
        width: 100%;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        font-family: var(--font-stack);
        padding: 12px;
        margin-bottom: 12px;
        outline: none;
        font-size: 16px;
    }

    input:focus {
        border-color: var(--accent-color);
    }

    .option-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }

    .option-row input {
        margin-bottom: 0;
    }

    .del-btn {
        padding: 12px;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        cursor: pointer;
    }

    .add-btn {
        width: 100%;
        padding: 12px;
        border: 1px dashed var(--border-color);
        background: transparent;
        color: var(--text-color);
        font-family: var(--font-stack);
        cursor: pointer;
        text-transform: uppercase;
        margin-bottom: 16px;
    }

    .add-btn:hover {
        background: #111;
    }

    button {
        width: 100%;
        padding: 14px;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        font-family: var(--font-stack);
        text-transform: uppercase;
        cursor: pointer;
        font-weight: bold;
    }

    button:hover {
        background: var(--text-color);
        color: var(--bg-color);
    }

    /* Vote View */
    .poll-title {
        font-size: 20px;
        text-align: center;
        margin-bottom: 24px;
        text-transform: uppercase;
        font-weight: bold;
    }

    .vote-option {
        border: 1px solid var(--border-color);
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        position: relative;
    }

    .vote-option:hover {
        background: #111;
    }

    .vote-option.selected {
        border-color: var(--accent-color);
    }

    .vote-option.voted {
        cursor: default;
    }

    .option-text {
        position: relative;
        z-index: 2;
        padding-bottom: 8px;
        font-size: 14px;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
    }

    .vote-bar {
        height: 4px;
        background: #333;
        width: 100%;
    }

    .vote-fill {
        height: 100%;
        background: var(--text-color);
        transition: width 0.3s;
    }

    .vote-option.selected .vote-fill {
        background: var(--accent-color);
    }

    .total-votes {
        text-align: center;
        font-size: 12px;
        opacity: 0.5;
        margin-top: 16px;
        text-transform: uppercase;
    }

    /* Toolbar */
    .toolbar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: var(--bg-color);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        padding: 16px;
    }

    .toolbar a {
        color: var(--text-color);
        text-decoration: none;
        font-family: var(--font-stack);
        font-size: 14px;
        text-transform: uppercase;
    }

    
</style>

<div class="container">
    <header>
        <h1>POLL</h1>
    </header>

    <div id="create-view">
        <div class="card">
            <h2>QUESTION</h2>
            <input type="text" id="question" placeholder="ENTER QUESTION...">

            <h2>OPTIONS</h2>
            <div id="options">
                <div class="option-row"><input type="text" placeholder="OPTION 1" value="YES"></div>
                <div class="option-row"><input type="text" placeholder="OPTION 2" value="NO"></div>
            </div>
            <button class="add-btn" id="add-option">+ ADD OPTION</button>

            <button id="create">CREATE POLL</button>
        </div>
    </div>

    <div id="vote-view" style="display:none">
        <div class="poll-title" id="poll-question"></div>
        <div id="vote-options"></div>
        <div class="total-votes" id="total-votes"></div>

        <div style="margin-top:24px; display:flex; gap:16px;">
            <button id="share-vote">SHARE</button>
            <button id="new-poll">NEW</button>
        </div>
    </div>
</div>

<div class="toolbar">
    <a href="index.html">[HOME]</a>
</div>

<div class="toast" id="toast">LINK COPIED</div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
    const toast = document.getElementById('toast');
    let pollData = null, hasVoted = false, votedIndex = -1, gun, pollNode;

    // Initialize Gun (lazy load on poll load)
    const relayUrl = localStorage.getItem('gun-relay-url');
    if (relayUrl) gun = Gun([relayUrl]);

    document.getElementById('add-option').addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'option-row';
        div.innerHTML = `<input type="text" placeholder="OPTION..."><button class="del-btn" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('options').appendChild(div);
    });

    document.getElementById('create').addEventListener('click', async () => {
        await createPoll();
        try { await navigator.clipboard.writeText(location.href); showToast('LINK COPIED'); } catch { }
    });

    document.getElementById('share-vote').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(location.href); showToast('LINK COPIED'); } catch { }
    });

    document.getElementById('new-poll').addEventListener('click', () => { location.hash = ''; location.reload(); });

    if (location.hash.length > 1) loadPoll();

    async function createPoll() {
        const question = document.getElementById('question').value || 'POLL';
        const inputs = document.querySelectorAll('#options input');
        const options = [...inputs].map(i => i.value).filter(v => v.trim());
        if (options.length < 2) { showToast('NEED 2+ OPTIONS'); return; }

        pollData = { q: question, o: options.map(o => ({ t: o, v: 0 })), id: Date.now() };
        await savePoll();
        showPoll();
        // Init sync for new poll
        if (gun) setupSync(pollData.id);
    }

    async function savePoll() {
        // Sync to Gun
        if (gun && pollData) {
            gun.get('shogun-polls').get(pollData.id.toString()).put({ data: JSON.stringify(pollData) });
        }
        await updateHash();
    }

    async function updateHash() {
        const hash = await compress(JSON.stringify(pollData));
        history.replaceState({}, '', '#' + hash);
    }

    async function loadPoll() {
        try {
            pollData = JSON.parse(await decompress(location.hash.slice(1)));
            const voted = localStorage.getItem('poll-' + pollData.id);
            if (voted !== null) { hasVoted = true; votedIndex = parseInt(voted); }
            showPoll();
            if (gun) setupSync(pollData.id);
        } catch { }
    }

    function setupSync(id) {
        if (!gun) return;
        gun.get('shogun-polls').get(id.toString()).on((data) => {
            if (data && data.data) {
                try {
                    const remote = JSON.parse(data.data);
                    // Update votes if greater (simple merge logic)
                    // Or just accept latest state for simplicity
                    let changed = false;
                    remote.o.forEach((o, i) => {
                        if (o.v > pollData.o[i].v) {
                            pollData.o[i].v = o.v;
                            changed = true;
                        }
                    });
                    if (changed) {
                        renderOptions();
                        updateHash();
                    }
                } catch (e) { }
            }
        });
    }

    function showPoll() {
        document.getElementById('create-view').style.display = 'none';
        document.getElementById('vote-view').style.display = 'block';
        document.getElementById('poll-question').textContent = pollData.q;
        document.title = 'POLL';
        renderOptions();
    }

    function renderOptions() {
        const total = pollData.o.reduce((s, o) => s + o.v, 0);
        const el = document.getElementById('vote-options');
        el.innerHTML = pollData.o.map((o, i) => {
            const pct = total ? Math.round(o.v / total * 100) : 0;
            const selected = votedIndex === i ? 'selected' : '';
            const voted = hasVoted ? 'voted' : '';
            return `
        <div class="vote-option ${selected} ${voted}" onclick="vote(${i})">
          <div class="option-text">
            <span>${o.t}</span>
            <span>${hasVoted ? pct + '%' : ''}</span>
          </div>
          ${hasVoted ? `<div class="vote-bar"><div class="vote-fill" style="width:${pct}%"></div></div>` : ''}
        </div>`;
        }).join('');
        document.getElementById('total-votes').textContent = hasVoted ? `${total} VOTES` : '';
    }

    window.vote = async (i) => {
        if (hasVoted) return;
        hasVoted = true; votedIndex = i;
        pollData.o[i].v++;
        localStorage.setItem('poll-' + pollData.id, i);
        await savePoll();
        renderOptions();
        showToast('VOTE SAVED');
    };

    async function compress(s) { const b = new TextEncoder().encode(s), st = new CompressionStream('deflate-raw'), w = st.writable.getWriter(); w.write(b); w.close(); return btoa(String.fromCharCode(...new Uint8Array(await new Response(st.readable).arrayBuffer()))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }
    async function decompress(b) { const bin = atob(b.replace(/-/g, '+').replace(/_/g, '/')), arr = Uint8Array.from(bin, c => c.charCodeAt(0)), st = new DecompressionStream('deflate-raw'), w = st.writable.getWriter(); w.write(arr); w.close(); return new TextDecoder().decode(await new Response(st.readable).arrayBuffer()); }
    function showToast(m) { toast.textContent = m; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2000); }
</script>