<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FILES</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<style>
    body {
        padding: 20px;
        padding-bottom: 100px;
        
        align-items: center;
    }

    .container {
        width: 100%;
        max-width: 600px;
    }

    header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }.storage-info {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 8px;
    }

    .upload-zone {
        border: 2px dashed var(--border-color);
        padding: 40px;
        text-align: center;
        margin-bottom: 20px;
        cursor: pointer;
        transition: border-color 0.3s;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--accent-color);
    }

    .upload-zone p {
        text-transform: uppercase;
        font-size: 12px;
        opacity: 0.7;
    }

    .file-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .file-item {
        display: flex;
        align-items: center;
        border: 1px solid var(--border-color);
        padding: 12px;
        gap: 12px;
    }

    .file-icon {
        font-size: 20px;
        width: 30px;
        text-align: center;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-size: 12px;
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-meta {
        font-size: 10px;
        opacity: 0.5;
        margin-top: 4px;
    }

    .file-actions {
        display: flex;
        gap: 8px;
    }

    .file-actions button {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        font-family: var(--font-stack);
        padding: 6px 10px;
        font-size: 10px;
        cursor: pointer;
        text-transform: uppercase;
    }

    .file-actions button:hover {
        background: var(--text-color);
        color: var(--bg-color);
    }

    .empty {
        text-align: center;
        padding: 40px;
        opacity: 0.5;
        text-transform: uppercase;
        font-size: 12px;
        border: 1px dashed var(--border-color);
    }

    .toolbar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: var(--bg-color);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        padding: 16px;
    }

    .toolbar a {
        color: var(--text-color);
        text-decoration: none;
        font-family: var(--font-stack);
        font-size: 14px;
        text-transform: uppercase;
    }

    

    input[type="file"] {
        display: none;
    }

    .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 100;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .preview-modal.show {
        display: flex;
    }

    .preview-modal img {
        max-width: 90%;
        max-height: 70%;
        object-fit: contain;
    }

    .preview-modal pre {
        max-width: 90%;
        max-height: 70%;
        overflow: auto;
        padding: 20px;
        border: 1px solid var(--border-color);
        font-family: var(--font-stack);
        font-size: 12px;
    }

    .preview-close {
        margin-top: 20px;
        background: transparent;
        border: 1px solid var(--text-color);
        color: var(--text-color);
        font-family: var(--font-stack);
        padding: 12px 24px;
        cursor: pointer;
        text-transform: uppercase;
    }
</style>

<div class="container">
    <header>
        <h1>FILES</h1>
        <div class="storage-info" id="storage-info">CALCULATING...</div>
    </header>

    <div class="upload-zone" id="upload-zone">
        <p>DROP FILES HERE OR CLICK TO UPLOAD</p>
    </div>
    <input type="file" id="file-input" multiple>

    <div class="file-list" id="file-list"></div>
</div>

<div class="preview-modal" id="preview-modal">
    <div id="preview-content"></div>
    <button class="preview-close" id="preview-close">CLOSE</button>
</div>

<div class="toolbar">
    <a href="index.html">[HOME]</a>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<script>
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const storageInfo = document.getElementById('storage-info');
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');
    const toast = document.getElementById('toast');

    let files = [];
    let gun, gunNode, user;

    // Initialize Gun
    const relayUrl = localStorage.getItem('gun-relay-url');
    if (relayUrl) {
        gun = Gun({ localStorage: false, peers: [relayUrl] });
        user = gun.user().recall({ sessionStorage: true });

        if (user.is) {
            gunNode = user.get('shogun-files');
        } else {
            gunNode = gun.get('shogun-files');
        }
    }

    // Load from localStorage
    loadFiles();

    // Upload zone events
    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
        fileInput.value = '';
    });

    document.getElementById('preview-close').addEventListener('click', () => {
        previewModal.classList.remove('show');
        previewContent.innerHTML = '';
    });

    async function handleFiles(fileObjects) {
        for (const file of fileObjects) {
            // Check size (max 5MB for base64 storage)
            if (file.size > 5 * 1024 * 1024) {
                showToast('MAX 5MB PER FILE');
                continue;
            }

            const reader = new FileReader();
            reader.onload = async () => {
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: reader.result,
                    date: Date.now()
                };
                files.push(fileData);
                await saveFiles();
                render();
                showToast('UPLOADED');
            };
            reader.readAsDataURL(file);
        }
    }

    window.downloadFile = (i) => {
        const file = files[i];
        const a = document.createElement('a');
        a.href = file.data;
        a.download = file.name;
        a.click();
    };

    window.previewFile = (i) => {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            previewContent.innerHTML = `<img src="${file.data}" alt="${file.name}">`;
        } else if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.json') || file.name.endsWith('.md')) {
            const text = atob(file.data.split(',')[1]);
            previewContent.innerHTML = `<pre>${escapeHtml(text)}</pre>`;
        } else {
            previewContent.innerHTML = `<p style="text-transform:uppercase;">PREVIEW NOT AVAILABLE</p>`;
        }
        previewModal.classList.add('show');
    };

    window.deleteFile = async (i) => {
        if (confirm('DELETE THIS FILE?')) {
            files.splice(i, 1);
            await saveFiles();
            render();
        }
    };

    async function saveFiles() {
        // Save metadata only to localStorage (data is too large)
        const meta = files.map(f => ({ name: f.name, type: f.type, size: f.size, date: f.date, data: f.data }));
        try {
            localStorage.setItem('files-data', JSON.stringify(meta));
        } catch (e) {
            showToast('STORAGE FULL');
        }

        // Sync file list (not data) to Gun for multi-device awareness
        if (gunNode) {
            const list = files.map(f => ({ name: f.name, type: f.type, size: f.size, date: f.date }));
            gunNode.put({ fileList: JSON.stringify(list) });
        }

        updateStorageInfo();
    }

    function loadFiles() {
        try {
            const stored = localStorage.getItem('files-data');
            if (stored) {
                files = JSON.parse(stored);
            }
        } catch { }
        render();
        updateStorageInfo();
    }

    function render() {
        if (files.length === 0) {
            fileList.innerHTML = '<div class="empty">NO FILES</div>';
            return;
        }

        fileList.innerHTML = files.map((f, i) => `
            <div class="file-item">
                <div class="file-icon">${getIcon(f.type)}</div>
                <div class="file-info">
                    <div class="file-name">${escapeHtml(f.name)}</div>
                    <div class="file-meta">${formatSize(f.size)} | ${new Date(f.date).toLocaleDateString()}</div>
                </div>
                <div class="file-actions">
                    <button onclick="previewFile(${i})">VIEW</button>
                    <button onclick="downloadFile(${i})">GET</button>
                    <button onclick="deleteFile(${i})">DEL</button>
                </div>
            </div>
        `).join('');
    }

    function getIcon(type) {
        if (type.startsWith('image/')) return 'üñº';
        if (type.startsWith('video/')) return 'üé¨';
        if (type.startsWith('audio/')) return 'üéµ';
        if (type.includes('pdf')) return 'üìÑ';
        if (type.includes('zip') || type.includes('rar')) return 'üì¶';
        return 'üìÅ';
    }

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function updateStorageInfo() {
        let totalSize = 0;
        files.forEach(f => totalSize += f.size);
        const used = formatSize(totalSize);
        storageInfo.textContent = `${files.length} FILES | ${used} USED`;
    }

    function escapeHtml(text) {
        return (text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }
</script>